define(["babylon","cannon","interface"],function(e,r,t){function i(r,t,i){r.activeCamera=new e.ArcRotateCamera("mainCamera",1,1,10,t,r),r.activeCamera.attachControl(i,!1),r.activeCamera.zoomOnFactor=.005,r.activeCamera.wheelPrecision=10,r.activeCamera.upperAlphaLimit=0,r.activeCamera.lowerAlphaLimit=0,r.activeCamera.upperBetaLimit=3.14,r.activeCamera.lowerBetaLimit=0,r.activeCamera.upperRadiusLimit=10,r.activeCamera.lowerRadiusLimit=0,r.activeCamera.panningSensibility=.5,r.activeCamera.checkCollisions=!0,r.activeCamera.collisionRadius=new e.Vector3(1,1,1),r.activeCamera.keysUp.pop(),r.activeCamera.keysDown.pop(),r.activeCamera.keysLeft.pop(),r.activeCamera.keysRight.pop()}Number.prototype.clamp=function(e,r){return Math.min(Math.max(this,e),r)};var a={engine:null,scene:null,keys:{},playground:{ground:null,sphere:null,size:null},renderCanvas:null,initEngine:function(r){function i(e){if(("Escape"==e.key||"Esc"==e.key)&&"keydown"==e.type){var r=(new Date).getTime();if(r-n<2e3)return;t.menu.visible?(t.menu.makeInvisible(!0),a.scene.activeCamera.attachControl(a.renderCanvas,!1)):(t.menu.makeVisible(!0),a.scene.activeCamera.detachControl(a.renderCanvas)),n=r}a.keys[e.key]="keydown"==e.type}t.initUI(this);var a=this;this.renderCanvas=r,this.engine||(this.engine=new e.Engine(r,!0)),window.addEventListener("resize",function(){a.engine.resize()});var n=(new Date).getTime();return e.Tools.RegisterTopRootEvents([{name:"keydown",handler:i},{name:"keyup",handler:i}]),this.engine},getEngine:function(){return this.engine},getScene:function(){return this.scene},createPlayground:function(r){if(this.engine){t.initScores(),this.scene&&this.scene.dispose(),this.scene=new e.Scene(this.engine),this.scene.enablePhysics(new e.Vector3(0,-9.8,0),new e.CannonJSPlugin);var a=[{width:r},{depth:r}],n=[{x:0,y:5,z:-(r/2-.5)},{x:0,y:5,z:r/2-.5},{x:-(r/2-.5),y:5,z:0},{x:r/2-.5,y:5,z:0}];this.playground.size=r,this.playground.ground=new Array;var o=e.Mesh.CreateBox("skyBox",100,this.scene);o.infiniteDistance=!0,o.renderingGroupId=0;var s=new e.StandardMaterial("skyBox",this.scene);o.material=s,s.backFaceCulling=!1,s.disableLighting=!0,s.diffuseColor=new e.Color3(0,0,0),s.specularColor=new e.Color3(0,0,0),s.reflectionTexture=new e.CubeTexture("./res/skybox/skybox",this.scene),s.reflectionTexture.coordinatesMode=e.Texture.SKYBOX_MODE;var l=new e.CubeTexture("./res/skybox/skybox",this.scene);l.name="reflTexture";var c=new e.PBRMaterial("borders",this.scene);c.microSurface=.6,c.reflectivityColor=new e.Color3(.2,.2,.2),c.albedoColor=new e.Color3(.1,.1,.1);for(var u=0;u<4;u++)this.playground.ground.push(e.MeshBuilder.CreateBox("border"+u,a[Math.floor(u/2)],this.scene)),this.playground.ground[u].scaling.y=10,this.playground.ground[u].position=new e.Vector3(n[u].x,n[u].y,n[u].z),this.playground.ground[u].material=c;var h=e.MeshBuilder.CreateGround("ground",{subdivisions:1},this.scene);h.scaling.x=r,h.scaling.z=r,h.material=new e.PBRMaterial("tiling",this.scene),h.material.albedoTexture=new e.Texture("./res/wood.jpg",this.scene),h.material.bumpTexture=new e.Texture("./res/woodNorm.jpg",this.scene),h.material.albedoTexture.uScale=h.material.bumpTexture.uScale=r/4,h.material.albedoTexture.vScale=h.material.bumpTexture.vScale=r/4,h.material.reflectivityColor=new e.Color3(.5,.5,.5),h.material.reflectionTexture=new e.MirrorTexture("groundMirror",256,this.scene,!0),h.material.reflectionTexture.mirrorPlane=new e.Plane(0,-1,0,0),h.material.microSurface=.8,h.material.reflectionTexture.renderList.push.apply(h.material.reflectionTexture.renderList,this.playground.ground),h.material.reflectionTexture.renderList.push(o),this.playground.ground.push(h);for(var u=0;u<5;u++)this.playground.ground[u].setPhysicsState({impostor:e.PhysicsEngine.BoxImpostor,move:!1,restitution:.5}),this.playground.ground[u].applyGravity=!1,this.playground.ground[u].checkCollisions=!0,this.playground.ground[u].receiveShadows=!0;this.playground.ground.push(o),this.playground.sphere=e.MeshBuilder.CreateSphere("sphere",{diameter:1},this.scene),i(this.scene,this.playground.sphere,this.renderCanvas),this.playground.sphere.checkCollisions=!1,this.playground.sphere.applyGravity=!0,this.playground.sphere.position.y=1,this.playground.sphere.material=new e.PBRMaterial("sphere",this.scene),this.playground.sphere.material.microSurface=.6,this.playground.sphere.material.reflectivityColor=new e.Color3(.5,.5,.5),this.playground.sphere.material.albedoColor=new e.Color3(1,0,0),this.playground.sphere.material.reflectionColor=new e.Color3(1,1,1),this.playground.sphere.setPhysicsState({impostor:e.PhysicsEngine.SphereImpostor,move:!0,mass:5,friction:.8,restitution:.5});var p=new e.ReflectionProbe("sphereProbe",256,this.scene);p.renderList.push.apply(p.renderList,this.playground.ground),p.attachToMesh(this.playground.sphere),this.playground.sphere.material.bumpTexture=new e.Texture("./res/scratchNorm.jpg",this.scene),this.playground.sphere.material.reflectionTexture=p.cubeTexture,this.playground.sphere.material.refractionTexture=p.cubeTexture,this.playground.sphere.receiveShadows=!0;for(var d=new Array,u=0;u<r;u++){if(Math.random()>.5){var m=Math.random().clamp(.5,1);d.push(e.MeshBuilder.CreateBox("bonus"+u,{size:m},this.scene)),d[u].setPhysicsState(e.PhysicsEngine.BoxImpostor,{move:!0,mass:m,friction:.2,restitution:1}),d[u].scoreValue=parseInt(1/m*100),d[u].size=m}else{var y=Math.random().clamp(.5,1);d.push(e.MeshBuilder.CreateSphere("bonus"+u,{diameter:y},this.scene)),d[u].setPhysicsState(e.PhysicsEngine.SphereImpostor,{move:!0,mass:y,friction:.2,restitution:1}),d[u].scoreValue=parseInt(1/y*1e3),d[u].size=y}d[u].checkCollisions=!1,d[u].applyGravity=!0,d[u].material=new e.PBRMaterial("bonus"+u+"mtl",this.scene),d[u].material.microSurface=Math.random(),d[u].material.indexOfRefraction=Math.random(),d[u].material.linkRefractionWithTransparency=!0,d[u].material.alpha=Math.random(),d[u].material.emissiveColor=new e.Color3(Math.random(),Math.random(),Math.random()),d[u].material.reflectivityColor=new e.Color3(Math.random(),Math.random(),Math.random()),d[u].material.reflectionColor=new e.Color3(Math.random(),Math.random(),Math.random()),d[u].material.albedoColor=new e.Color3(Math.random(),Math.random(),Math.random()),d[u].material.reflectionTexture=l,d[u].material.refractionTexture=l,d[u].position=new e.Vector3((Math.random()-.5)*(r/2),2,(Math.random()-.5)*(r/2)),d[u].scoreValue=parseInt(100*Math.random()),d[u].receiveShadows=!0;this.scene;d[u].physicsImpostor.registerOnPhysicsCollide(this.playground.sphere.physicsImpostor,function(e,r){var i=r.object.material.reflectionTexture,a=r.object.material.bumpTexture;r.object.material.dispose(),r.object.material=e.object.material.clone("bonus"+d.indexOf(e)+"mtl_clone"),r.object.material.reflectionTexture=i,r.object.material.refractionTexture=i,r.object.material.bumpTexture=a,e.object.registerAfterRender(function(e){d.splice(d.indexOf(e),1),t.updateScore(e.scoreValue),t.updateBonus(d.length),e.dispose()})})}t.updateBonus(d.length),h.material.reflectionTexture.renderList.push.apply(h.material.reflectionTexture.renderList,d),h.material.reflectionTexture.renderList.push(this.playground.sphere),p.renderList.push.apply(p.renderList,d);var g=new e.DirectionalLight("light",new e.Vector3(-1,-1,-1),this.scene);g.autoUpdateExtends=!1;var f=new e.HemisphericLight("fillLight",new e.Vector3(-1,-1,-1),this.scene);f.indensity=.001,f.specular=new e.Color3(0,0,0);var v=new e.ShadowGenerator(1024,g);v.getShadowMap().renderList.push.apply(v.getShadowMap().renderList,d),v.getShadowMap().renderList.push(this.playground.ground[0],this.playground.ground[1],this.playground.ground[2],this.playground.ground[3]),v.getShadowMap().renderList.push(this.playground.sphere),v.bias=2e-5,v.useVarianceShadowMap=!1,v.usePoissonSampling=!0;var x=e.MeshBuilder.CreatePlane("topCollider",{size:r},this.scene);return x.rotate(e.Axis.X,-1.5,e.Space.LOCAL),x.position.y=9.5,x.visibility=!1,x.setPhysicsState({impostor:e.PhysicsEngine.BoxImpostor,move:!1}),this.scene}},initRendering:function(){if(this.engine&&this.scene){var r=this,i=this.playground.sphere,a=0,n=0;this.scene.registerBeforeRender(function(){if(!t.menu.visible&&(n=a=0,(r.keys.Left||r.keys.ArrowLeft)&&n++,(r.keys.Right||r.keys.ArrowRight)&&n--,(r.keys.Up||r.keys.ArrowUp)&&a++,(r.keys.Down||r.keys.ArrowDown)&&a--,n||a)){var o=r.scene.activeCamera.position,s=i.physicsImpostor.getLinearVelocity(),l=i.position.subtract(new e.Vector3(o.x,i.position.y,o.z)).normalize(),c=e.Vector3.Cross(l,new e.Vector3(0,1,0));l=l.scale(a).scale(.1),c=c.scale(n).scale(.1),s=s.add(l),s=s.add(c),s.x=s.x.clamp(-4,4),s.z=s.z.clamp(-4,4),i.physicsImpostor.setLinearVelocity(s,i.getAbsolutePosition())}}),this.scene.executeWhenReady(function(){r.engine.runRenderLoop(function(){r.scene.render()})});var o=0;this.scene.afterRender=function(){if(o++,!(o<=60)){var t=(r.engine.getFps(),new e.SceneOptimization(3));t.apply=function(e){if(!e.isReady())return!1;for(var r,t=0;t<e.textures.length;t++)if("reflTexture"==e.textures[t].name){r=e.textures[t];break}e.materials.forEach(function(e){void 0!=e.reflectionTexture&&"reflTexture"!=e.reflectionTexture.name&&(e.reflectionTexture.dispose(),e.reflectionTexture=r),void 0!=e.refractionTexture&&"reflTexture"!=e.refractionTexture.name&&(e.refractionTexture.dispose(),e.refractionTexture=r)});for(var t=0;t<e.reflectionProbes.length;t++)e.reflectionProbes.dispose();return!0};var i=new e.SceneOptimizerOptions(24,5e3);i.optimizations.push(t),i.optimizations.push(new e.HardwareScalingOptimization(0,4)),i.optimizations.push(new e.TextureOptimization(1,512)),i.optimizations.push(new e.TextureOptimization(2,256)),e.SceneOptimizer.OptimizeAsync(r.scene,i),r.scene.afterRender=null}}}}};return a});